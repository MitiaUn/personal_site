---
const { items, inlineHeader = false } = Astro.props;
---

<div class={`relative border-l border-slate-200 dark:border-slate-800 ml-4 md:ml-6 ${inlineHeader ? 'space-y-8' : ''}`}>
  {items.map((item, index) => (
    <div class="mb-10 ml-6 group cursor-pointer toggle-container">
      <div class="absolute w-3 h-3 bg-slate-300 dark:bg-slate-700 rounded-full mt-1.5 -left-1.5 border border-white dark:border-slate-900 group-hover:bg-blue-500 transition-colors duration-300"></div>
      
      {inlineHeader ? (
        <div class="flex flex-col sm:flex-row sm:items-baseline gap-1 sm:gap-2 mb-2">
            <div class="text-slate-500 dark:text-slate-400 text-base font-medium min-w-fit">{item.date}</div>
            <div class="text-slate-900 dark:text-white font-semibold text-xl group-hover:text-blue-500 transition-colors"> <span class="text-slate-400 mx-2">â€¢</span> {item.title}</div>
            <div class="text-slate-600 dark:text-slate-400 text-lg">at {item.organization}</div>
        </div>
      ) : (
        <>
          <time class="mb-1 text-sm font-normal leading-none text-slate-400 dark:text-slate-500">{item.date}</time>
          <h3 class="text-xl font-semibold text-slate-900 dark:text-white mt-1 group-hover:text-blue-500 transition-colors">{item.title}</h3>
          <p class="text-base font-medium text-slate-600 dark:text-slate-400">{item.organization}</p>
        </>
      )}
      <p class="mt-2 text-base font-normal text-slate-500 dark:text-slate-400 max-w-2xl">{item.description}</p>
      {item.highlights && item.highlights.length > 0 && (
        <div class="mt-3">
          <button class="text-blue-600 hover:text-blue-800 dark:text-blue-400 dark:hover:text-blue-300 text-sm font-medium focus:outline-none toggle-highlights transition-colors duration-200 flex items-center gap-1" aria-expanded="false">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 transform transition-transform duration-300" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
            </svg>
          </button>
          <div class="grid grid-rows-[0fr] transition-[grid-template-rows] duration-300 ease-out highlights-wrapper">
            <div class="overflow-hidden">
              <ul class="mt-2 space-y-1 list-disc list-inside text-sm text-slate-500 dark:text-slate-400">
                {item.highlights.map(highlight => (
                  <li>{highlight}</li>
                ))}
              </ul>
            </div>
          </div>
        </div>
      )}
    </div>
  ))}
</div>

<script>
  function setupToggles() {
    const containers = document.querySelectorAll('.toggle-container');
    
    containers.forEach(container => {
      if (container.hasAttribute('data-initialized')) return;
      container.setAttribute('data-initialized', 'true');

      container.addEventListener('click', (e) => {
        // Prevent triggering if clicking on a link (if any links were added later)
        if ((e.target as HTMLElement).tagName === 'A') return;

        const button = container.querySelector('.toggle-highlights');
        const wrapper = container.querySelector('.highlights-wrapper');
        const icon = container.querySelector('svg');
        
        if (wrapper && button) {
          const isExpanded = wrapper.classList.contains('grid-rows-[1fr]');
          
          if (isExpanded) {
            wrapper.classList.remove('grid-rows-[1fr]');
            wrapper.classList.add('grid-rows-[0fr]');
            if (icon) icon.style.transform = 'rotate(0deg)';
            button.setAttribute('aria-expanded', 'false');
          } else {
            wrapper.classList.remove('grid-rows-[0fr]');
            wrapper.classList.add('grid-rows-[1fr]');
            if (icon) icon.style.transform = 'rotate(180deg)';
            button.setAttribute('aria-expanded', 'true');
          }
        }
      });
    });
  }

  // Run on initial load
  setupToggles();

  // Re-run on view transitions if enabled
  document.addEventListener('astro:page-load', setupToggles);
</script>
