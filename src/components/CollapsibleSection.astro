---
interface Props {
  id: string;
  title: string;
  icon?: string;
  iconColorClass: string;
  description: string;
  open?: boolean;
  indent?: boolean;
}

const { id, title, icon, iconColorClass, description, open = false, indent = true } = Astro.props;
---

<div class="collapsible-section" id={id}>
  <button 
    class="w-full text-left py-4 focus:outline-none highlight-none group"
    aria-expanded={open}
    aria-controls={`${id}-content`}
  >
    <div class="flex items-start gap-4">
      <div class={`w-10 h-10 rounded-xl ${iconColorClass} flex items-center justify-center text-xl shadow-sm shrink-0 mt-1`}>
        <slot name="icon">{icon}</slot>
      </div>
      <div class="flex-grow">
        <div class="flex items-center justify-between">
          <h2 class="text-2xl font-bold text-slate-900 dark:text-white group-hover:text-blue-600 dark:group-hover:text-blue-400 transition-colors">
            {title}
          </h2>
           <svg 
              xmlns="http://www.w3.org/2000/svg" 
              class="h-6 w-6 text-slate-400 transform transition-transform duration-300 chevron" 
              fill="none" 
              viewBox="0 0 24 24" 
              stroke="currentColor"
          >
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
          </svg>
        </div>
        <div class="text-base text-slate-600 dark:text-slate-300 mt-2 font-light leading-relaxed">
          <slot name="description">{description}</slot>
        </div>
      </div>
    </div>
  </button>
  
  <div 
    id={`${id}-content`}
    class={`grid transition-[grid-template-rows] duration-500 ease-in-out ${open ? 'grid-rows-[1fr]' : 'grid-rows-[0fr]'}`}
  >
    <div class="overflow-hidden">
      <div class={`pb-6 ${indent ? 'pl-[3.5rem]' : 'pl-0'}`}>
        <slot />
      </div>
    </div>
  </div>
</div>

<script>
  function setupCollapsible() {
    const buttons = document.querySelectorAll('.collapsible-section button');
    
    // Function to expand a section
    const expandSection = (button) => {
      const isExpanded = button.getAttribute('aria-expanded') === 'true';
      if (!isExpanded) {
         button.setAttribute('aria-expanded', 'true');
         const content = button.nextElementSibling;
         const chevron = button.querySelector('.chevron');
         if (content && chevron) {
            content.classList.remove('grid-rows-[0fr]');
            content.classList.add('grid-rows-[1fr]');
            chevron.style.transform = 'rotate(180deg)';
         }
      }
    };

    // Click handler
    buttons.forEach(button => {
      if (button.hasAttribute('data-initialized')) return;
      button.setAttribute('data-initialized', 'true');

      button.addEventListener('click', () => {
        const isExpanded = button.getAttribute('aria-expanded') === 'true';
         
        // Toggle
        button.setAttribute('aria-expanded', (!isExpanded).toString());
        const content = button.nextElementSibling;
        const chevron = button.querySelector('.chevron');
        
        if (content && chevron) {
           if (isExpanded) {
             content.classList.remove('grid-rows-[1fr]');
             content.classList.add('grid-rows-[0fr]');
             chevron.style.transform = 'rotate(0deg)';
           } else {
             content.classList.remove('grid-rows-[0fr]');
             content.classList.add('grid-rows-[1fr]');
             chevron.style.transform = 'rotate(180deg)';
           }
        }
      });
    });

    // Check hash for auto-expansion
    const checkHash = () => {
        const hash = window.location.hash.substring(1);
        if (hash) {
            // Find if the hash corresponds to a section wrapper that contains a collapsible section
            // The structure is <section id="hash"> <CollapsibleSection ...> </section>
            const sectionWrapper = document.getElementById(hash);
            if (sectionWrapper) {
                const collapsibleButton = sectionWrapper.querySelector('.collapsible-section button');
                if (collapsibleButton) {
                    expandSection(collapsibleButton);
                }
            }
        }
    };
    
    checkHash();
    window.addEventListener('hashchange', checkHash);
  }

  // Run on initial load
  setupCollapsible();

  // Re-run on view transitions if enabled
  document.addEventListener('astro:page-load', setupCollapsible);
</script>
