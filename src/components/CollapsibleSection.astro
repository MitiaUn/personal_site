---
interface Props {
  id: string;
  title: string;
  icon?: string;
  iconColorClass: string;
  description: string;
  open?: boolean;
  indent?: boolean;
  hintText?: string;
}

const { id, title, icon, iconColorClass, description, open = false, indent = true, hintText } = Astro.props;
---

<div class="collapsible-section rounded-2xl p-6 transition-[border-color,box-shadow] duration-300 hover:shadow-lg border border-transparent hover:border-blue-500/10" id={id}>
  <button 
    class="w-full text-left focus:outline-none highlight-none group"
    aria-expanded={open}
    aria-controls={`${id}-content`}
  >
    <div class="flex items-start gap-4">
      <div class={`w-10 h-10 rounded-xl ${iconColorClass} flex items-center justify-center text-xl shadow-sm shrink-0 mt-1 transition-transform group-hover:scale-110 duration-300`}>
        <slot name="icon">{icon}</slot>
      </div>
      <div class="flex-grow">
        <div class="flex items-center justify-between">
          <h2 class="text-2xl font-bold text-slate-900 dark:text-white group-hover:text-blue-600 dark:group-hover:text-blue-400 transition-colors">
            {title}
          </h2>
           <svg 
              xmlns="http://www.w3.org/2000/svg" 
              class="h-6 w-6 text-slate-400 transform transition-transform duration-300 chevron group-hover:text-blue-500" 
              fill="none" 
              viewBox="0 0 24 24" 
              stroke="currentColor"
          >
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
          </svg>
        </div>
        <div class="text-sm text-slate-600 dark:text-slate-300 mt-2 font-light leading-relaxed group-hover:text-slate-700 dark:group-hover:text-slate-200 transition-colors">
          <slot name="description">{description}</slot>
        </div>
        {hintText && (
          <p class="hint-text text-sm text-slate-400 dark:text-slate-500 italic mt-2 transition-opacity duration-300" style={open ? 'opacity: 0; height: 0; overflow: hidden;' : ''}>{hintText}</p>
        )}
      </div>
    </div>
  </button>
  
  <div 
    id={`${id}-content`}
    class={`grid transition-[grid-template-rows] duration-500 ease-in-out mt-4 ${open ? 'grid-rows-[1fr]' : 'grid-rows-[0fr]'}`}
  >
    <div class="overflow-hidden">
      <div class={`pb-6 ${indent ? 'pl-[3.5rem]' : 'pl-0'}`}>
        <slot />
      </div>
    </div>
  </div>
</div>

<script>
  function setupCollapsible() {
    const buttons = document.querySelectorAll('.collapsible-section button');
    
    // Function to expand a section
    const expandSection = (button) => {
      const isExpanded = button.getAttribute('aria-expanded') === 'true';
      if (!isExpanded) {
         button.setAttribute('aria-expanded', 'true');
         const content = button.nextElementSibling;
         const chevron = button.querySelector('.chevron');
         const hintText = button.querySelector('.hint-text');
         if (content && chevron) {
            content.classList.remove('grid-rows-[0fr]');
            content.classList.add('grid-rows-[1fr]');
            chevron.style.transform = 'rotate(180deg)';
         }
         if (hintText) {
            hintText.style.opacity = '0';
            hintText.style.height = '0';
            hintText.style.overflow = 'hidden';
         }
      }
    };

    // Click handler
    buttons.forEach(button => {
      if (button.hasAttribute('data-initialized')) return;
      button.setAttribute('data-initialized', 'true');

      button.addEventListener('click', () => {
        const isExpanded = button.getAttribute('aria-expanded') === 'true';
         
        // Toggle
        button.setAttribute('aria-expanded', (!isExpanded).toString());
        const hintText = button.querySelector('.hint-text');
        const content = button.nextElementSibling;
        const chevron = button.querySelector('.chevron');
        
        if (content && chevron) {
           if (isExpanded) {
             content.classList.remove('grid-rows-[1fr]');
             content.classList.add('grid-rows-[0fr]');
             chevron.style.transform = 'rotate(0deg)';
             if (hintText) {
               hintText.style.opacity = '1';
               hintText.style.height = '';
               hintText.style.overflow = '';
             }
           } else {
             content.classList.remove('grid-rows-[0fr]');
             content.classList.add('grid-rows-[1fr]');
             chevron.style.transform = 'rotate(180deg)';
             if (hintText) {
               hintText.style.opacity = '0';
               hintText.style.height = '0';
               hintText.style.overflow = 'hidden';
             }
           }
        }
      });
    });

    // Sections that should NOT auto-expand when navigated to (removed experience so it expands)
    const excludedSections = ['projects'];

    // Listen for global collapse event
    document.addEventListener('collapse-all-sections', () => {
      buttons.forEach(button => {
        const isExpanded = button.getAttribute('aria-expanded') === 'true';
        if (isExpanded) {
          // Collapse
          button.setAttribute('aria-expanded', 'false');
          const content = button.nextElementSibling;
          const chevron = button.querySelector('.chevron');
          const hintText = button.querySelector('.hint-text');
          if (content && chevron) {
             content.classList.remove('grid-rows-[1fr]');
             content.classList.add('grid-rows-[0fr]');
             chevron.style.transform = 'rotate(0deg)';
             if (hintText) {
               hintText.style.opacity = '1';
               hintText.style.height = '';
               hintText.style.overflow = '';
             }
          }
        }
      });
    });

    // Expand section from hash (used on initial load)
    const expandFromHash = () => {
      const hash = window.location.hash.substring(1);
      if (hash && !excludedSections.includes(hash)) {
        const sectionWrapper = document.getElementById(hash);
        if (sectionWrapper) {
          const btn = sectionWrapper.querySelector('.collapsible-section button');
          if (btn) expandSection(btn);
        }
      }
    };

    // Listen for clicks on navigation links to expand the target section
    document.querySelectorAll('a.nav-link, a[href*="#"]').forEach(link => {
      if (link.hasAttribute('data-collapse-initialized')) return;
      link.setAttribute('data-collapse-initialized', 'true');

      link.addEventListener('click', (e) => {
        const href = link.getAttribute('href') || '';
        
        // Check for special collapse action
        if (link.getAttribute('data-action') === 'collapse-all') {
            document.dispatchEvent(new CustomEvent('collapse-all-sections'));
            return; 
        }

        // Skip links handled by Navigation.astro's CV toggle logic
        if (link.getAttribute('data-action') === 'toggle-cv') return;
        if (link.closest('#cv-submenu')) return;

        const hashIndex = href.indexOf('#');
        if (hashIndex === -1) return;
        const hash = href.substring(hashIndex + 1);
        
        // If it's a section link, collapse others? User didn't ask for accordion style, just "unfold".
        // But clicking a sub-section implies focus. 
        // For now, just expand the target.
        
        if (!hash || excludedSections.includes(hash)) return;

        // Small delay to let the browser navigate/scroll first
        setTimeout(() => {
          const sectionWrapper = document.getElementById(hash);
          if (sectionWrapper) {
            const btn = sectionWrapper.querySelector('.collapsible-section button');
            if (btn) expandSection(btn);
          }
        }, 150);
      });
    });

    expandFromHash();
  }

  // Run on initial load
  setupCollapsible();

  // Re-run on view transitions if enabled
  document.addEventListener('astro:page-load', setupCollapsible);
</script>

<style>
  .collapsible-section:hover {
    background-image: linear-gradient(to bottom right, rgba(59, 130, 246, 0.08), rgba(147, 51, 234, 0.08));
    background-color: rgba(0, 0, 0, 0.75);
  }
</style>
